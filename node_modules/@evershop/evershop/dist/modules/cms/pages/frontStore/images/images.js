import { imageProcessor } from '../../../services/imageProcessor.js';
export default async (request, response, next) => {
    const src = typeof request.query.src === 'string' ? request.query.src : '';
    const width = parseInt(request.query.w, 10);
    const height = request.query.h
        ? parseInt(request.query.h, 10)
        : undefined;
    // Default quality to 75 if not provided or invalid
    const quality = parseInt(request.query.q, 10) || 75;
    const format = ['jpeg', 'png', 'webp', 'avif'].includes(request.query.f)
        ? request.query.f
        : 'webp';
    if (!src ||
        !width ||
        isNaN(width) ||
        (height !== undefined && isNaN(height))) {
        return response.status(400).send('Invalid parameters');
    }
    try {
        const result = await imageProcessor(src, width, quality, format, height);
        response.setHeader('Content-Type', result.metadata.contentType);
        response.setHeader('Cache-Control', 'public, max-age=31536000, immutable');
        // Send only the buffer data, not the entire result object
        response.send(result.buffer);
    }
    catch (error) {
        response.status(404).send('Not Found');
    }
};
//# sourceMappingURL=images.js.map
import { Tooltip } from '@components/common/form/Tooltip.js';
import { getNestedError } from '@components/common/form/utils/getNestedError.js';
import { _ } from '@evershop/evershop/lib/locale/translate/_';
import React from 'react';
import { useFormContext } from 'react-hook-form';
export function FileField({ name, label, error, wrapperClassName, helperText, required, validation, maxSize, className, accept, multiple = false, ...props }) {
    const { register, formState: { errors }, watch } = useFormContext();
    const fieldError = getNestedError(name, errors, error);
    const fieldId = `field-${name}`;
    const files = watch(name);
    const formatFileSize = (bytes) => {
        if (bytes === 0)
            return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    };
    const { valueAsNumber, valueAsDate, ...cleanValidation } = validation || {};
    const validationRules = {
        ...cleanValidation,
        ...(required &&
            !(validation === null || validation === void 0 ? void 0 : validation.required) && {
            required: _('${field} is required', { field: label || name })
        }),
        validate: {
            ...validation === null || validation === void 0 ? void 0 : validation.validate,
            fileSize: (fileList) => {
                if (!maxSize || !fileList || fileList.length === 0)
                    return true;
                for (let i = 0; i < fileList.length; i++) {
                    if (fileList[i].size > maxSize) {
                        return _('File size must be less than ${maxSize}', {
                            maxSize: formatFileSize(maxSize)
                        });
                    }
                }
                return true;
            }
        }
    };
    return (React.createElement("div", { className: `form-field ${wrapperClassName} ${fieldError ? 'error' : ''}` },
        label && (React.createElement("label", { htmlFor: fieldId },
            label,
            required && React.createElement("span", { className: "required-indicator" }, "*"),
            helperText && React.createElement(Tooltip, { content: helperText, position: "top" }))),
        React.createElement("input", { id: fieldId, type: "file", accept: accept, multiple: multiple, ...register(name, validationRules), className: className, "aria-invalid": fieldError !== undefined ? 'true' : 'false', "aria-describedby": fieldError !== undefined ? `${fieldId}-error` : undefined, ...props }),
        maxSize && (React.createElement("p", { className: "file-size-hint" },
            "Maximum file size: ",
            formatFileSize(maxSize))),
        files && files.length > 0 && (React.createElement("div", { className: "file-list" },
            React.createElement("p", { className: "file-list-label" }, "Selected files:"),
            React.createElement("ul", { className: "file-items" }, Array.from(files).map((file, index) => (React.createElement("li", { key: index },
                file.name,
                " (",
                formatFileSize(file.size),
                ")")))))),
        fieldError && (React.createElement("p", { id: `${fieldId}-error`, className: "field-error" }, fieldError))));
}
//# sourceMappingURL=FileField.js.map